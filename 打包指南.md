# 绿色软件打包指南

## 准备工作

### 1. 完成开发环境设置

```bash
# 运行安装脚本
install.bat

# 等待所有依赖安装完成
```

### 2. 测试功能

```bash
# 启动服务测试
start.bat

# 访问 http://localhost:5173 测试所有功能
# 测试完成后停止服务
stop.bat
```

## 打包方案

### 方案A: 简单压缩包（推荐新手）

#### 步骤：

1. **清理项目**
```bash
# 删除不必要的文件
del /s /q __pycache__
del /s /q *.pyc
del /s /q .pytest_cache
del /s /q frontend\.cache
del /s /q frontend\dist
```

2. **准备配置文件**
```bash
# 编辑 .env，移除实际的API密钥
# 保留示例格式：
DEEPSEEK_API_KEY=your_key_here
```

3. **创建使用说明**
   创建 `使用说明.txt`：
```
LangGraph Agent Web 使用指南
============================

首次使用：
1. 编辑 .env 文件，填入你的 DEEPSEEK_API_KEY
2. 双击运行 install.bat（仅首次需要）
3. 双击运行 start.bat 启动服务
4. 浏览器会自动打开 http://localhost:5173

日常使用：
- 启动: 双击 start.bat
- 停止: 双击 stop.bat
- 菜单: 双击 menu.bat

注意事项：
- 需要安装 Python 3.10+ 和 Node.js 18+
- 确保网络连接正常（需访问DeepSeek API）
- 对话记录保存在 conversations 文件夹

技术支持：
https://github.com/your-repo
```

4. **打包**
```bash
# 使用 7-Zip 或 WinRAR 压缩整个项目文件夹
# 命名为: LangGraph-Agent-Web-v1.0.zip
```

#### 打包内容清单：
```
✓ src/               # 源代码
✓ frontend/          # 前端代码
✓ venv/              # Python虚拟环境
✓ conversations/     # 对话目录（可为空）
✓ *.bat              # 批处理脚本
✓ .env               # 配置文件（移除密钥）
✓ requirements.txt   # Python依赖列表
✓ CLAUDE.md          # 开发文档
✓ README_WEB.md      # 用户文档
✓ 使用说明.txt       # 快速指南
```

---

### 方案B: Inno Setup 安装包（推荐进阶）

#### 1. 安装 Inno Setup

下载地址: https://jrsoftware.org/isdl.php

#### 2. 创建安装脚本 `setup.iss`

```inno
[Setup]
AppName=LangGraph Agent Web
AppVersion=1.0
DefaultDirName={autopf}\LangGraphAgent
DefaultGroupName=LangGraph Agent
OutputDir=output
OutputBaseFilename=LangGraphAgentSetup
Compression=lzma2
SolidCompression=yes

[Files]
Source: "*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs

[Icons]
Name: "{group}\LangGraph Agent"; Filename: "{app}\start.bat"
Name: "{group}\停止服务"; Filename: "{app}\stop.bat"
Name: "{group}\配置"; Filename: "{app}\.env"
Name: "{commondesktop}\LangGraph Agent"; Filename: "{app}\start.bat"

[Run]
Filename: "{app}\install.bat"; Description: "安装依赖"; Flags: postinstall runascurrentuser
Filename: "{app}\.env"; Description: "配置API密钥"; Flags: postinstall shellexec

[Code]
function InitializeSetup(): Boolean;
var
  ResultCode: Integer;
begin
  // 检查 Python
  if not RegKeyExists(HKEY_LOCAL_MACHINE, 'SOFTWARE\Python\PythonCore\3.10') and
     not RegKeyExists(HKEY_LOCAL_MACHINE, 'SOFTWARE\Python\PythonCore\3.11') and
     not RegKeyExists(HKEY_LOCAL_MACHINE, 'SOFTWARE\Python\PythonCore\3.12') then
  begin
    MsgBox('未检测到Python 3.10+，请先安装Python！', mbError, MB_OK);
    Result := False;
    Exit;
  end;

  Result := True;
end;
```

#### 3. 编译安装包

```bash
# 使用 Inno Setup 编译 setup.iss
# 生成 LangGraphAgentSetup.exe
```

---

### 方案C: PyInstaller + Electron（最完整方案）

#### 1. 打包后端为独立exe

创建 `build_backend.py`:
```python
import PyInstaller.__main__

PyInstaller.__main__.run([
    'src/api/main.py',
    '--name=agent-backend',
    '--onefile',
    '--hidden-import=uvicorn',
    '--hidden-import=fastapi',
    '--hidden-import=langchain',
    '--collect-all=langchain',
    '--collect-all=langgraph',
])
```

运行:
```bash
venv\Scripts\python build_backend.py
```

#### 2. 打包前端为生产版本

```bash
cd frontend
npm run build
```

#### 3. 创建Electron包装器

安装electron:
```bash
npm install -g electron-packager
```

创建 `electron-main.js`:
```javascript
const { app, BrowserWindow } = require('electron');
const { spawn } = require('child_process');
const path = require('path');

let backend = null;
let mainWindow = null;

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    webPreferences: {
      nodeIntegration: false
    }
  });

  // 启动后端服务
  backend = spawn(path.join(__dirname, 'agent-backend.exe'));

  // 等待后端启动
  setTimeout(() => {
    mainWindow.loadURL('http://localhost:8000/static/index.html');
  }, 3000);
}

app.whenReady().then(createWindow);

app.on('before-quit', () => {
  if (backend) backend.kill();
});
```

打包:
```bash
electron-packager . LangGraphAgent --platform=win32 --arch=x64
```

---

## 发布检查清单

- [ ] 所有功能测试通过
- [ ] .env 文件中无敏感信息
- [ ] README 文档完整
- [ ] 批处理脚本运行正常
- [ ] 清理了临时文件和缓存
- [ ] 包含使用说明文档
- [ ] 测试安装包/压缩包
- [ ] 准备技术支持渠道

## 体积优化建议

### 减少打包体积：

1. **排除开发依赖**
```bash
# 仅打包生产依赖
pip freeze > requirements-full.txt
# 手动编辑 requirements.txt，移除测试相关包
```

2. **前端优化**
```bash
cd frontend
npm run build
# 只打包 dist/ 文件夹，不打包 src/
```

3. **清理Python缓存**
```bash
del /s /q __pycache__
del /s /q *.pyc
```

4. **使用虚拟环境**
   - 不打包全局Python环境
   - 只打包venv虚拟环境

预期打包大小：
- 压缩包方式: ~500MB（包含venv和node_modules）
- Electron方式: ~200MB（优化后）

## 常见问题

### Q: 打包后无法运行？
A: 检查Python和Node.js是否在PATH中，或使用绝对路径

### Q: 如何更新版本？
A: 修改代码后重新运行打包流程，更新版本号

### Q: 如何分发？
A:
- 小文件: 通过网盘分享（百度云、阿里云盘等）
- 大文件: 使用BT种子或分卷压缩
- 正式发布: GitHub Releases

## 技术支持

如有问题，请查看：
- CLAUDE.md - 开发文档
- README_WEB.md - 用户文档
- GitHub Issues
