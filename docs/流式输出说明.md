# 流式输出说明

## 概述

系统现在支持流式输出（Streaming Response），AI 的回复会逐字显示，而不是等待全部生成完成。

## 实现细节

### Backend

**1. 流式 LLM 调用** (`src/agents/simple_llm.py`)
- `call_llm_stream()` - 使用 LangChain 的 `astream()` 方法
- 逐 token yield 返回
- 完整回复会被记录到日志文件

**2. 流式 API 端点** (`src/api/routers/chat.py`)
- `POST /api/chat/stream` - 新的流式端点
- 返回 SSE (Server-Sent Events) 格式
- 格式: `data: {"chunk": "..."}\n\n`
- 结束标记: `data: {"done": true}\n\n`

**3. Agent Service** (`src/api/services/agent_service_simple.py`)
- `process_message_stream()` - 流式处理方法
- 收集完整回复并保存到会话文件

### Frontend

**1. API 客户端** (`frontend/src/services/api.ts`)
- `sendMessageStream()` - 使用 Fetch API 读取流式响应
- 支持三个回调:
  - `onChunk(chunk)` - 收到每个 token
  - `onDone()` - 完成
  - `onError(error)` - 错误

**2. Chat Hook** (`frontend/src/hooks/useChat.ts`)
- 修改为使用 `sendMessageStream()`
- 先创建空的 assistant 消息占位符
- 实时更新消息内容

## 技术栈

- **SSE (Server-Sent Events)**: 标准的 HTTP 流式传输协议
- **LangChain Streaming**: `ChatOpenAI.astream()`
- **Fetch Streams API**: 前端读取流式响应

## 性能特点

- ✅ **更快的感知响应**: 用户立即看到开始生成
- ✅ **更好的体验**: 类似 ChatGPT 的打字效果
- ✅ **相同成本**: API 调用次数不变（仍然只调用 1 次）
- ✅ **完整记录**: 流式输出的完整内容仍会保存到日志和会话文件

## 如何使用

### 启动服务

```bash
# 后端
start_backend.bat

# 前端
start_frontend.bat
```

### 测试流式输出

1. 打开浏览器访问 http://localhost:5173
2. 创建新会话或选择已有会话
3. 发送消息
4. 观察 AI 回复逐字显示

### 查看日志

```bash
python view_logs.py
```

流式输出的完整内容会在传输完成后记录到日志文件。

## 技术细节

### SSE 数据格式

```
data: {"chunk": "你"}\n\n
data: {"chunk": "好"}\n\n
data: {"chunk": "，"}\n\n
data: {"chunk": "我"}\n\n
data: {"chunk": "是"}\n\n
data: {"done": true}\n\n
```

### 错误处理

```
data: {"error": "Session not found"}\n\n
```

## 与非流式版本对比

| 特性 | 非流式 (`/api/chat`) | 流式 (`/api/chat/stream`) |
|------|---------------------|--------------------------|
| 响应方式 | 完整响应 | 逐 token 响应 |
| 用户体验 | 等待完成后显示 | 实时显示 |
| API 调用 | 1 次 | 1 次 |
| 网络传输 | 一次性 | 分块传输 |
| 日志记录 | 完整记录 | 完整记录 |
| 实现复杂度 | 简单 | 中等 |

## 注意事项

1. **CORS**: 确保后端 CORS 配置允许流式响应
2. **超时**: 流式响应可能需要更长的超时时间
3. **重连**: 前端没有实现自动重连（连接断开需要重新发送）
4. **取消**: 当前未实现取消生成功能（可以关闭页面）

## 未来改进

- [ ] 添加"停止生成"按钮
- [ ] 实现自动重连机制
- [ ] 添加流式输出的速率限制
- [ ] 支持多模态流式输出（图片、代码等）
